<!DOCTYPE html>
<html>
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a"><meta charset="UTF-8">
<title>Brewing & Fermentation Calculator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
        /* CSS Variables for Light Theme */
        :root {
            --bg-color: #f9f9f9;
            --card-bg: #fff;
            --text-color: #2c3e50;
            --border-color: #ccc;
            --input-bg: #fff;
            --button-bg: #3498db;
            --button-text: #fff;
            --secondary-text: #7f8c8d;
            --gradient-bar: linear-gradient(to right, #2ecc71, #f39c12, #e74c3c);
            --indicator-color: #2c3e50;
            --tip-bg: rgba(52, 152, 219, 0.1);
            --tip-border: rgba(52, 152, 219, 0.2);
            --h1-light-color: #2563eb; /* Equivalent to Tailwind blue-600 */
        }

        /* CSS Variables for Dark Theme (matching the image) */
        [data-theme="dark"] {
            --bg-color: #1c2a38; /* Dark blue-grey background */
            --card-bg: #2a3d4f; /* Slightly lighter dark blue-grey for cards */
            --text-color: #e0e0e0; /* Light grey text */
            --border-color: #4a6177; /* Darker blue-grey border */
            --input-bg: #3a5068; /* Darker blue-grey for inputs */
            --button-bg: #4a90e2; /* Blue button */
            --button-text: #fff; /* White button text */
            --secondary-text: #b0b0b0; /* Lighter grey secondary text */
            --gradient-bar: linear-gradient(to right, #27ae60, #e67e22, #c0392b); /* Green, orange, red gradient */
            --indicator-color: #e0e0e0; /* Light grey indicator */
            --tip-bg: rgba(74, 144, 226, 0.1); /* Blue tint for tips */
            --tip-border: rgba(74, 144, 226, 0.2);
            --h1-dark-color: #60a5fa; /* Equivalent to Tailwind blue-400 */
        }

        /* General Body Styling */
        body {
            font-family: Arial, sans-serif;
            padding: 15px; /* Reduced padding */
            max-width: 750px;
            margin: auto;
            background: var(--bg-color);
            padding-bottom: 80px; /* Reduced padding */
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition for theme change */
            font-size: 0.95em; /* Slightly smaller base font size */
        }

        /* Main Heading */
        h1 {
            color: var(--h1-light-color); /* Use the specific light mode blue */
            text-align: center;
            margin-bottom: 25px; /* Reduced margin */
            font-size: 1.8em; /* Further reduced font size for H1 */
            font-weight: bold; /* Ensure bold font */
        }

        /* Dark mode specific color for h1 */
        [data-theme="dark"] h1 {
            color: var(--h1-dark-color); /* Use the specific dark mode blue */
        }

        /* Theme Toggle Button */
        .theme-toggle {
            position: fixed;
            top: 15px; /* Adjusted position */
            right: 15px; /* Adjusted position */
            background: var(--button-bg);
            color: var(--button-text);
            border: none;
            border-radius: 50px;
            padding: 8px 12px; /* Slightly smaller padding */
            cursor: pointer;
            font-size: 13px; /* Slightly smaller font size */
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .theme-toggle:hover {
            opacity: 0.8;
        }

        /* Section Headings (now acting as separators) */
        h2 {
            color: var(--text-color);
            margin-top: 30px; /* Reduced space above to act as a separator */
            margin-bottom: 12px; /* Reduced margin */
            font-size: 1.3em; /* Slightly smaller font size */
        }

        /* Labels, Inputs, Selects */
        label, input, select {
            display: block;
            margin-top: 8px; /* Reduced margin */
            color: var(--text-color);
        }

        /* Updated input styling to include text type and ensure consistent color */
        input[type="number"], input[type="text"], select {
            width: 100%;
            padding: 6px; /* Reduced padding */
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-color); /* Explicitly set text color */
            font-size: 0.9em; /* Slightly smaller font size */
        }

        /* Buttons */
        button {
            background: var(--button-bg);
            color: var(--button-text);
            border: none;
            padding: 8px 15px; /* Reduced padding */
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            transition: opacity 0.3s ease;
            font-size: 0.9em; /* Slightly smaller font size */
        }

        button:hover {
            opacity: 0.8;
        }

        /* Result Display */
        .result {
            margin-top: 15px; /* Reduced margin */
            padding: 8px; /* Reduced padding */
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-color);
            font-size: 0.9em; /* Slightly smaller font size */
        }

        .sweetness { color: #8e44ad; font-weight: bold; } /* Specific color for sweetness text */

        /* Sweetness Bar */
        .sweetness-bar-container {
            width: 100%;
            height: 18px; /* Slightly smaller height */
            background: var(--gradient-bar);
            border-radius: 9px; /* Adjusted border-radius */
            margin: 6px 0; /* Reduced margin */
            position: relative;
            border: 1px solid var(--border-color);
        }

        .sweetness-indicator {
            position: absolute;
            top: -1px; /* Adjusted position */
            width: 3px; /* Slightly smaller width */
            height: 20px; /* Slightly smaller height */
            background: var(--indicator-color);
            border-radius: 2px;
            transition: left 0.3s ease;
        }

        .sweetness-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px; /* Slightly smaller font size */
            color: var(--secondary-text);
            margin-top: 2px;
        }

        /* Status and Progress Text */
        .status, .progress { font-weight: bold; padding: 4px 0; } /* Reduced padding */
        .complete { color: #27ae60; } /* Green for complete */
        .nearly { color: #e67e22; } /* Orange for nearly complete */
        .active { color: #e74c3c; } /* Red for active */

        /* Volume Input Group (for side-by-side input and select) */
        .volume-input-group {
            display: flex;
            gap: 8px; /* Reduced gap */
            align-items: flex-end;
        }

        .volume-input-group input {
            flex: 2;
        }

        .volume-input-group select {
            flex: 1;
        }

        /* Unit Conversion Notes */
        .unit-note {
            font-size: 11px; /* Slightly smaller font size */
            color: var(--secondary-text);
            margin-top: 4px; /* Reduced margin */
        }

        /* Canvas for Charts */
        canvas {
            margin-top: 15px; /* Reduced margin */
            background: var(--card-bg);
            border-radius: 4px;
            padding: 8px; /* Reduced padding */
        }

        /* Individual Calculator Sections */
        .calculator-section {
            background: var(--card-bg);
            padding: 15px; /* Reduced padding */
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 25px; /* Reduced margin */
        }

        /* Wort Correction Factor Container (already existed, similar styling) */
        .wcf-container {
            background: var(--card-bg); /* Use card-bg for consistency */
            padding: 15px; /* Reduced padding */
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin: 15px 0; /* Reduced margin */
        }

        .wcf-label {
            display: block;
            font-weight: bold;
            font-size: 13px; /* Slightly smaller font size */
            margin-bottom: 6px; /* Reduced margin */
            color: var(--text-color);
        }

        .wcf-description {
            font-size: 12px; /* Slightly smaller font size */
            color: var(--text-color);
            line-height: 1.4; /* Adjusted line height */
            margin-bottom: 10px; /* Reduced margin */
        }

        .wcf-tip {
            background: var(--tip-bg);
            border: 1px solid var(--tip-border);
            border-radius: 6px;
            padding: 10px; /* Reduced padding */
            margin-top: 10px; /* Reduced margin */
            font-size: 11px; /* Slightly smaller font size */
            color: var(--secondary-text);
        }

        .tip-icon {
            color: var(--button-bg);
            margin-right: 5px; /* Reduced margin */
        }

        .highlight {
            color: var(--button-bg);
            font-weight: 500;
        }

        .remove-reading-button {
            background-color: #e74c3c; /* Red color for remove button */
            color: white;
            border: none;
            border-radius: 50%; /* Make it circular */
            width: 25px; /* Fixed width */
            height: 25px; /* Fixed height */
            font-size: 14px; /* "X" size */
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-left: 10px; /* Space from the input field */
            flex-shrink: 0; /* Prevent shrinking */
            position: relative;
            top: 10px; /* Align with input field */
        }

        .remove-reading-button:hover {
            opacity: 0.8;
        }
    </style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<button class="theme-toggle" onclick="toggleTheme()">🌙 Dark Mode</button>

<h1>Brewing & Fermentation Calculator</h1>

<h2>Refractometer ABV/Brix Calculator</h2>
<div class="calculator-section">
    <div class="wcf-container">
        <label for="og_brix">Original Brix (WRI):</label>
        <input id="og_brix" step="0.01" type="number" value="18.0"/>
        <label for="fg_brix">Current Brix (WRI):</label>
        <input id="fg_brix" step="0.01" type="number" value="5.0"/>
        <label for="wcf" class="wcf-label">Wort Correction Factor</label>
        <div class="wcf-description">
            Fine-tune this factor using a <span class="highlight">completed bone dry batch</span> where you know the exact sugar additions or tested with a Hydrometer.
            Adjust until the calculated ABV matches your expected result from sugar input.
            The default (1.038) works for most setups, but calibrating ensures accuracy for your specific equipment and process.
        </div>
        <div class="wcf-tip">
            <span class="tip-icon">💡</span>
            <strong>Pro Tip:</strong> Use the Simple Sugar to ABV Estimator below to verify your expected ABV from total sugar and volume.
        </div>
        <input id="wcf" step="0.001" type="number" value="1.038"/>
    </div>
    <label for="volume_input">Volume for Calorie Calculation:</label>
    <div class="volume-input-group">
        <input id="volume_input" step="0.01" type="number" value="500"/>
        <select id="volume_unit">
            <option value="ml">mL</option>
            <option value="us_fl_oz">US fl oz</option>
            <option value="uk_fl_oz">UK fl oz</option>
            <option value="us_cup">US cup</option>
            <option value="us_pint">US pint</option>
            <option value="uk_pint">UK pint</option>
            <option value="us_quart">US quart</option>
            <option value="uk_quart">UK quart</option>
            <option value="us_gallon">US gallon</option>
            <option value="uk_gallon">UK gallon</option>
            <option value="liter">Liter</option>
        </select>
    </div>
    <div class="unit-note" id="volume_note">500 mL = 16.91 US fl oz = 17.60 UK fl oz</div>
    <button onclick="calculateRefractometerAndEnableUpdates()">Calculate</button>
    <div class="result" id="output"></div>
    </div>

<h2>Traditional Hydrometer (SG) Calculator</h2>
<div class="calculator-section">
    <label for="og_sg">Original Gravity (OG):</label>
    <input id="og_sg" step="0.001" type="number" value="1.0713"/>
    <label for="fg_sg">Final Gravity (FG):</label>
    <input id="fg_sg" step="0.001" type="number" value="0.9985"/>
    <label for="volume_input_sg">Volume for Calorie Calculation:</label>
    <div class="volume-input-group">
        <input id="volume_input_sg" step="0.01" type="number" value="500"/>
        <select id="volume_unit_sg">
            <option value="ml">mL</option>
            <option value="us_fl_oz">US fl oz</option>
            <option value="uk_fl_oz">UK fl oz</option>
            <option value="us_cup">US cup</option>
            <option value="us_pint">US pint</option>
            <option value="uk_pint">UK pint</option>
            <option value="us_quart">US quart</option>
            <option value="uk_quart">UK quart</option>
            <option value="us_gallon">US gallon</option>
            <option value="uk_gallon">UK gallon</option>
            <option value="liter">Liter</option>
        </select>
    </div>
    <div class="unit-note" id="volume_note_sg">500 mL = 16.91 US fl oz = 17.60 UK fl oz</div>
    <button onclick="calculateHydrometerAndEnableUpdates()">Calculate from SG</button>
    <div class="result" id="sg_output"></div>
    <canvas id="abvChartHydrometer" width="600" height="300"></canvas>

    <h3>SG Readings Over Time</h3>
    <div id="sg_readings_container">
        </div>
    <button onclick="addSgReadingField()">Add New Reading</button>
</div>

<h2>Simple Sugar to ABV Estimator</h2>
<div class="calculator-section">
    <label for="sugar_amount">Total Sugar Used:</label>
    <div class="volume-input-group">
        <input id="sugar_amount" step="0.01" type="number" value="4018"/>
        <select id="sugar_unit">
            <option value="grams" selected>Grams</option>
            <option value="kg">Kilograms</option>
            <option value="lbs">Pounds (lbs)</option>
            <option value="oz">Ounces (oz)</option>
            <option value="us_cups">US Cups</option>
            <option value="uk_cups">UK Cups</option>
        </select>
    </div>
    <div class="unit-note" id="sugar_note">3565 g = 3.57 kg = 7.86 lbs = 125.8 oz</div>
    <label for="volume_liters">Total Liquid Volume:</label>
    <div class="volume-input-group">
        <input id="volume_liters" step="0.01" type="number" value="25"/>
        <select id="batch_volume_unit">
            <option value="ml">mL</option>
            <option value="us_fl_oz">US fl oz</option>
            <option value="uk_fl_oz">UK fl oz</option>
            <option value="us_cup">US cup</option>
            <option value="us_pint">US pint</option>
            <option value="uk_pint">UK pint</option>
            <option value="us_quart">US quart</option>
            <option value="uk_quart">UK quart</option>
            <option value="us_gallon">US gallon</option>
            <option value="uk_gallon">UK gallon</option>
            <option value="liter" selected>Liter</option>
        </select>
    </div>
    <div class="unit-note" id="batch_volume_note">25 L = 6.60 US gal = 5.50 UK gal</div>
    <label for="conversion_factor">Sugar per 1% ABV (g/L):</label>
    <input id="conversion_factor" step="0.01" type="number" value="16.83"/>
    <button onclick="calculateSugarABVAndEnableUpdates()">Estimate ABV</button>
    <div class="result" id="sugar_abv_output"></div>
</div>

<h2>Target ABV to Sugar Requirement</h2>
<div class="calculator-section">
    <label for="target_abv">Desired ABV (%):</label>
    <input id="target_abv" step="0.01" type="number" value="9.55"/>
    <label for="target_volume">Batch Volume:</label>
    <div class="volume-input-group">
        <input id="target_volume" step="0.01" type="number" value="25"/>
        <select id="target_volume_unit">
            <option value="ml">mL</option>
            <option value="us_fl_oz">US fl oz</option>
            <option value="uk_fl_oz">UK fl oz</option>
            <option value="us_cup">US cup</option>
            <option value="us_pint">US pint</option>
            <option value="uk_pint">UK pint</option>
            <option value="us_quart">US quart</option>
            <option value="uk_quart">UK quart</option>
            <option value="us_gallon">US gallon</option>
            <option value="uk_gallon">UK gallon</option>
            <option value="liter" selected>Liter</option>
        </select>
    </div>
    <div class="unit-note" id="target_volume_note">25 L = 6.60 US gal = 5.50 UK gal</div>
    <label for="target_factor">Sugar per 1% ABV (g/L):</label>
    <input id="target_factor" step="0.01" type="number" value="16.83"/>
    <button onclick="calculateRequiredSugarAndEnableUpdates()">Calculate Required Sugar</button>
    <div class="result" id="required_sugar_output"></div>
</div>

<h2>Priming Sugar Calculator</h2>
<div class="calculator-section">
    <label for="prime_volume">Batch Volume:</label>
    <div class="volume-input-group">
        <input id="prime_volume" step="0.01" type="number" value="500"/>
        <select id="prime_volume_unit">
            <option value="ml">mL</option>
            <option value="us_fl_oz">US fl oz</option>
            <option value="uk_fl_oz">UK fl oz</option>
            <option value="us_cup">US cup</option>
            <option value="us_pint">US pint</option>
            <option value="uk_pint">UK pint</option>
            <option value="us_quart">US quart</option>
            <option value="uk_quart">UK quarts</option>
            <option value="us_gallon">US gallon</option>
            <option value="uk_gallon">UK gallon</loption>
            <option value="liter">Liter</option>
        </select>
    </div>
    <div class="unit-note" id="prime_volume_note">500 mL = 16.91 US fl oz = 17.60 UK fl oz</div>
    <label for="co2_volumes">Desired CO2 Volumes:</label>
    <input id="co2_volumes" step="0.1" type="number" value="2.5"/>
    <label for="current_temp">Current Temperature (°C):</label>
    <input id="current_temp" step="0.1" type="number" value="20"/>
    <label for="sugar_type">Sugar Type:</label>
    <select id="sugar_type">
        <option value="table">Table Sugar (Sucrose)</option>
        <option value="corn">Corn Sugar (Dextrose)</option>
        <option value="dme">Dry Malt Extract</option>
        <option value="honey">Honey</option>
    </select>
    <button onclick="calculatePrimingSugarAndEnableUpdates()">Calculate Priming Sugar</button>
    <div class="result" id="priming_output"></div>
</div>

<h2>Dilution Calculator</h2>
<div class="calculator-section">
    <label for="current_abv">Current ABV (%):</label>
    <input id="current_abv" step="0.01" type="number" value="60"/>
    <label for="current_volume">Current Volume:</label>
    <div class="volume-input-group">
        <input id="current_volume" step="0.01" type="number" value="1"/>
        <select id="current_volume_unit">
            <option value="ml">mL</option>
            <option value="us_fl_oz">US fl oz</option>
            <option value="uk_fl_oz">UK fl oz</option>
            <option value="us_cup">US cup</soption>
            <option value="us_pint">US pint</option>
            <option value="uk_pint">UK pint</option>
            <option value="us_quart">US quart</option>
            <option value="uk_quart">UK quart</option>
            <option value="us_gallon">US gallon</option>
            <option value="uk_gallon">UK gallon</option>
            <option value="liter" selected>Liter</option>
        </select>
    </div>
    <div class="unit-note" id="current_volume_note">20 L = 5.28 US gal = 4.40 UK gal</div>
    <label for="target_abv_dilution">Target ABV (%):</label>
    <input id="target_abv_dilution" step="0.01" type="number" value="40"/>

    <label for="dilution_calorie_volume_input">Volume for Kcal Calculation:</label>
    <div class="volume-input-group">
        <input id="dilution_calorie_volume_input" step="0.01" type="number" value="100"/>
        <select id="dilution_calorie_volume_unit">
            <option value="ml">mL</option>
            <option value="us_fl_oz">US fl oz</option>
            <option value="uk_fl_oz">UK fl oz</option>
            <option value="us_cup">US cup</soption>
            <option value="us_pint">US pint</option>
            <option value="uk_pint">UK pint</option>
            <option value="us_quart">US quart</option>
            <option value="uk_quart">UK quarts</option>
            <option value="us_gallon">US gallon</option>
            <option value="uk_gallon">UK gallon</option>
            <option value="liter">Liter</option>
        </select>
    </div>
    <div class="unit-note" id="dilution_calorie_note">100 mL = 3.38 US fl oz = 3.52 UK fl oz</div>

    <button onclick="calculateDilutionAndEnableUpdates()">Calculate Water Needed</button>
    <div class="result" id="dilution_output"></div>
</div>

<h2>Blending Calculator</h2>
<div class="calculator-section">
    <label for="batch1_abv">Batch 1 ABV (%):</label>
    <input id="batch1_abv" step="0.01" type="number" value="40"/>
    <label for="batch1_volume">Batch 1 Volume:</label>
    <div class="volume-input-group">
        <input id="batch1_volume" step="0.01" type="number" value="300"/>
        <select id="batch1_volume_unit">
            <option value="ml">mL</option>
            <option value="us_fl_oz">US fl oz</option>
            <option value="uk_fl_oz">UK fl oz</option>
            <option value="us_cup">US cup</option>
            <option value="us_pint">US pint</option>
            <option value="uk_pint">UK pint</option>
            <option value="us_quart">US quart</option>
            <option value="uk_quart">UK quarts</option>
            <option value="us_gallon">US gallon</option>
            <option value="uk_gallon">UK gallon</option>
            <option value="liter">Liter</option>
        </select>
    </div>
    <div class="unit-note" id="batch1_volume_note">15 L = 3.96 US gal = 3.30 UK gal</div>
    <label for="batch2_abv">Batch 2 ABV (%):</label>
    <input id="batch2_abv" step="0.01" type="number" value="9.55"/>
    <label for="batch2_volume">Batch 2 Volume:</label>
    <div class="volume-input-group">
        <input id="batch2_volume" step="0.01" type="number" value="700"/>
        <select id="batch2_volume_unit">
            <option value="ml">mL</option>
            <option value="us_fl_oz">US fl oz</option>
            <option value="uk_fl_oz">UK fl oz</option>
            <option value="us_cup">US cup</option>
            <option value="us_pint">US pint</option>
            <option value="uk_pint">UK pint</option>
            <option value="us_quart">US quart</option>
            <option value="uk_quart">UK quarts</option>
            <option value="us_gallon">US gallon</option>
            <option value="uk_gallon">UK gallon</option>
            <option value="liter">Liter</option>
        </select>
    </div>
    <div class="unit-note" id="batch2_volume_note">10 L = 2.64 US gal = 2.20 UK gal</div>
    <button onclick="calculateBlendingAndEnableUpdates()">Calculate Blend Result</button>
    <div class="result" id="blending_output"></div>
</div>


<script>

/* PWA bootstrap */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker
      .register('./service-worker.js')
      .then(reg => console.log('[PWA] Service-worker registered', reg.scope))
      .catch(err => console.warn('[PWA] SW registration failed:', err));
  });
}

        // Theme management
        function toggleTheme() {
            const body = document.body;
            const button = document.querySelector('.theme-toggle');

            if (body.hasAttribute('data-theme')) {
                body.removeAttribute('data-theme');
                button.textContent = '🌙 Dark Mode';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                button.textContent = '☀️ Light Mode';
                localStorage.setItem('theme', 'dark');
            }
        }

        // Load saved theme
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const button = document.querySelector('.theme-toggle');

            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                button.textContent = '☀️ Light Mode';
            }
        }

        // Unit conversion factors to mL
        const volumeConversions = {
            ml: 1,
            us_fl_oz: 29.5735,
            uk_fl_oz: 28.4131,
            us_cup: 236.588,
            us_pint: 473.176,
            uk_pint: 568.261,
            us_quart: 946.353,
            uk_quart: 1136.52,
            us_gallon: 3785.41,
            uk_gallon: 4546.09,
            liter: 1000
        };

        // Sugar conversion factors to grams
        const sugarConversions = {
            grams: 1,
            kg: 1000,
            lbs: 453.592,
            oz: 28.3495,
            us_cups: 200, // Approximate for granulated sugar
            uk_cups: 227  // UK cup is slightly larger
        };

        function convertToMl(value, unit) {
            return value * volumeConversions[unit];
        }

        function convertFromMl(valueInMl, targetUnit) {
            return valueInMl / volumeConversions[targetUnit];
        }

        function convertToGrams(value, unit) {
            return value * sugarConversions[unit];
        }

        function convertFromGrams(valueInGrams, targetUnit) {
            return valueInGrams / sugarConversions[targetUnit];
        }

        // Common volume unit options for all dropdowns
        const commonVolumeOptions = `
            <option value="ml">mL</option>
            <option value="us_fl_oz">US fl oz</option>
            <option value="uk_fl_oz">UK fl oz</option>
            <option value="us_cup">US cup</option>
            <option value="us_pint">US pint</option>
            <option value="uk_pint">UK pint</option>
            <option value="us_quart">US quart</option>
            <option value="uk_quart">UK quart</option>
            <option value="us_gallon">US gallon</option>
            <option value="uk_gallon">UK gallon</option>
            <option value="liter">Liter</option>
        `;

        function updateSugarDisplay() {
            const value = parseFloat(document.getElementById("sugar_amount").value) || 0;
            const unit = document.getElementById("sugar_unit").value;
            const valueInGrams = convertToGrams(value, unit);

            const kg = convertFromGrams(valueInGrams, 'kg');
            const lbs = convertFromGrams(valueInGrams, 'lbs');
            const oz = convertFromGrams(valueInGrams, 'oz');

            document.getElementById("sugar_note").textContent =
                `${valueInGrams.toFixed(0)} g = ${kg.toFixed(2)} kg = ${lbs.toFixed(2)} lbs = ${oz.toFixed(1)} oz`;
        }

        function updateVolumeDisplay() {
            const value = parseFloat(document.getElementById("volume_input").value) || 0;
            const unit = document.getElementById("volume_unit").value;
            const valueInMl = convertToMl(value, unit);

            const usFlOz = convertFromMl(valueInMl, 'us_fl_oz');
            const ukFlOz = convertFromMl(valueInMl, 'uk_fl_oz');

            document.getElementById("volume_note").textContent =
                `${valueInMl.toFixed(0)} mL = ${usFlOz.toFixed(2)} US fl oz = ${ukFlOz.toFixed(2)} UK fl oz`;
        }

        function updateVolumeDisplaySG() {
            const value = parseFloat(document.getElementById("volume_input_sg").value) || 0;
            const unit = document.getElementById("volume_unit_sg").value;
            const valueInMl = convertToMl(value, unit);

            const usFlOz = convertFromMl(valueInMl, 'us_fl_oz');
            const ukFlOz = convertFromMl(valueInMl, 'uk_fl_oz');

            document.getElementById("volume_note_sg").textContent =
                `${valueInMl.toFixed(0)} mL = ${usFlOz.toFixed(2)} US fl oz = ${ukFlOz.toFixed(2)} UK fl oz`;
        }

        function updateBatchVolumeDisplay() {
            const value = parseFloat(document.getElementById("volume_liters").value) || 0;
            const unit = document.getElementById("batch_volume_unit").value;
            const valueInL = unit === 'liter' ? value : convertToMl(value, unit) / 1000;

            const usGal = convertFromMl(valueInL * 1000, 'us_gallon');
            const ukGal = convertFromMl(valueInL * 1000, 'uk_gallon');

            document.getElementById("batch_volume_note").textContent =
                `${valueInL.toFixed(1)} L = ${usGal.toFixed(2)} US gal = ${ukGal.toFixed(2)} UK gal`;
        }

        function updateTargetVolumeDisplay() {
            const value = parseFloat(document.getElementById("target_volume").value) || 0;
            const unit = document.getElementById("target_volume_unit").value;
            const valueInL = unit === 'liter' ? value : convertToMl(value, unit) / 1000;

            const usGal = convertFromMl(valueInL * 1000, 'us_gallon');
            const ukGal = convertFromMl(valueInL * 1000, 'uk_gallon');

            document.getElementById("target_volume_note").textContent =
                `${valueInL.toFixed(1)} L = ${usGal.toFixed(2)} US gal = ${ukGal.toFixed(2)} UK gal`;
        }

        function updatePrimeVolumeDisplay() {
            const value = parseFloat(document.getElementById("prime_volume").value) || 0;
            const unit = document.getElementById("prime_volume_unit").value;
            const valueInL = unit === 'liter' ? value : convertToMl(value, unit) / 1000;

            const usGal = convertFromMl(valueInL * 1000, 'us_gallon');
            const ukGal = convertFromMl(valueInL * 1000, 'uk_gallon');

            document.getElementById("prime_volume_note").textContent =
                `${valueInL.toFixed(1)} L = ${usGal.toFixed(2)} US gal = ${ukGal.toFixed(2)} UK gal`;
        }

        function updateDilutionCurrentVolumeDisplay() {
            const value = parseFloat(document.getElementById("current_volume").value) || 0;
            const unit = document.getElementById("current_volume_unit").value;
            const valueInL = unit === 'liter' ? value : convertToMl(value, unit) / 1000;

            const usGal = convertFromMl(valueInL * 1000, 'us_gallon');
            const ukGal = convertFromMl(valueInL * 1000, 'uk_gallon');

            document.getElementById("current_volume_note").textContent =
                `${valueInL.toFixed(1)} L = ${usGal.toFixed(2)} US gal = ${ukGal.toFixed(2)} UK gal`;
        }

        function updateBatch1VolumeDisplay() {
            const value = parseFloat(document.getElementById("batch1_volume").value) || 0;
            const unit = document.getElementById("batch1_volume_unit").value;
            const valueInL = unit === 'liter' ? value : convertToMl(value, unit) / 1000;

            const usGal = convertFromMl(valueInL * 1000, 'us_gallon');
            const ukGal = convertFromMl(valueInL * 1000, 'uk_gallon');

            document.getElementById("batch1_volume_note").textContent =
                `${valueInL.toFixed(1)} L = ${usGal.toFixed(2)} US gal = ${ukGal.toFixed(2)} UK gal`;
        }

        function updateBatch2VolumeDisplay() {
            const value = parseFloat(document.getElementById("batch2_volume").value) || 0;
            const unit = document.getElementById("batch2_volume_unit").value;
            const valueInL = unit === 'liter' ? value : convertToMl(value, unit) / 1000;

            const usGal = convertFromMl(valueInL * 1000, 'us_gallon');
            const ukGal = convertFromMl(valueInL * 1000, 'uk_gallon');

            document.getElementById("batch2_volume_note").textContent =
                `${valueInL.toFixed(1)} L = ${usGal.toFixed(2)} US gal = ${ukGal.toFixed(2)} UK gal`;
        }

        function updateDilutionCalorieVolumeDisplay() {
            const value = parseFloat(document.getElementById("dilution_calorie_volume_input").value) || 0;
            const unit = document.getElementById("dilution_calorie_volume_unit").value;
            const valueInMl = convertToMl(value, unit);

            const usFlOz = convertFromMl(valueInMl, 'us_fl_oz');
            const ukFlOz = convertFromMl(valueInMl, 'uk_fl_oz');

            document.getElementById("dilution_calorie_note").textContent =
                `${valueInMl.toFixed(0)} mL = ${usFlOz.toFixed(2)} US fl oz = ${ukFlOz.toFixed(2)} UK fl oz`;
        }


        let abvChartRefractometer;
        let abvChartHydrometer;

        function updateChart(canvasId, sgVals, abvVal, labels = ['Original', 'Final']) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            let chart;

            if (canvasId === 'abvChartRefractometer') {
                // Chart for refractometer is removed, so this block is no longer needed
                // if (abvChartRefractometer) abvChartRefractometer.destroy();
                // chart = new Chart(ctx, {
                //     type: 'line',
                //     data: {
                //         labels: labels, // Use provided labels
                //         datasets: [{
                //             label: 'SG Progress',
                //             data: sgVals,
                //             borderColor: 'teal',
                //             fill: false,
                //             tension: 0.1
                //         }]
                //     },
                //     options: {
                //         plugins: {
                //             title: { display: true, text: `Estimated ABV: ${abvVal}%` }
                //         },
                //         scales: {
                //             y: { beginAtZero: false }
                //         }
                //     }
                // });
                // abvChartRefractometer = chart;
            } else if (canvasId === 'abvChartHydrometer') {
                if (abvChartHydrometer) abvChartHydrometer.destroy();
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels, // Use provided labels
                        datasets: [{
                            label: 'SG Progress',
                            data: sgVals,
                            borderColor: 'teal',
                            fill: false,
                            tension: 0.1
                        }]
                    },
                    options: {
                        plugins: {
                            title: { display: true, text: `Estimated ABV: ${abvVal}%` }
                        },
                        scales: {
                            y: { beginAtZero: false }
                        }
                    }
                });
                abvChartHydrometer = chart;
            }
        }

        // Function to convert Brix to Refractive Index (RI) - KEPT FOR REFERENCE, NOT USED IN FG CALC
        function brixToRI(brix) {
            return 1.33302 + 0.001427193 * brix + 0.000005791157 * Math.pow(brix, 2);
        }

        function calculate() {
            const ogBrix = parseFloat(document.getElementById("og_brix").value);
            const fgBrix = parseFloat(document.getElementById("fg_brix").value);
            const wcf = parseFloat(document.getElementById("wcf").value);
            const volumeInput = parseFloat(document.getElementById("volume_input").value);
            const volumeUnit = document.getElementById("volume_unit").value;
            const volumeMl = convertToMl(volumeInput, volumeUnit);

            if (isNaN(ogBrix) || isNaN(fgBrix) || isNaN(wcf) || isNaN(volumeMl)) {
                 document.getElementById("output").innerHTML =
                    '<span class="active">Please enter valid numeric values for Brix, WCF, and Volume.</span>';
                // No chart to destroy for refractometer, so removed the chart.destroy() call here.
                return;
            }

            // OG calculation from corrected OBrix
            const correctedObrix = ogBrix / wcf;
            const og_sg = 1 + (correctedObrix / (258.6 - ((correctedObrix / 258.2) * 227.1)));

            // Reverted FG calculation using Brix values directly (from brix_logic_patch.html)
            // This formula is known to provide more accurate "dry" results for refractometer readings.
            const FG = 1.0000 - 0.00085683 * ogBrix + 0.0034941 * fgBrix + 0.0000051118 * Math.pow(ogBrix, 2) - 0.000013228 * Math.pow(fgBrix, 2) - 0.00000083764 * Math.pow(ogBrix, 3) + 0.00000018017 * Math.pow(fgBrix, 3);


            const abv_std = (og_sg - FG) * 131.25;
            const abv_alt = ((76.08 * (og_sg - FG)) / (1.775 - og_sg)) * (FG / 0.794);

            // Calculate residual sugar in g/L and for the specified volume
            const residualSugarGL = calculateResidualSugar(FG);
            const residualSugarInVolume = (residualSugarGL * volumeMl) / 1000; // Convert to grams in the specified volume

            // Calculate calories for Alcohol & Sugar
            const alcoholAndSugarCalories = (volumeMl * (abv_std / 100) * 0.789) * 7 + (residualSugarInVolume * 4);

            // Calculate sweetness percentage for visual display (0-100%)
            const sweetnessPercentage = calculateSweetnessPercentage(residualSugarGL);

            // Calculate sweetness classification
            const sweetness = getSweetnessClassification(FG, Math.max(abv_std, abv_alt));

            const final_target_FG = 1.0001; // Target FG for 100% fermentation
            let fermentation_progress = 0;
            if ((og_sg - final_target_FG) !== 0) {
                fermentation_progress = ((og_sg - FG) / (og_sg - final_target_FG)) * 100;
            } else if (og_sg <= FG) { // Edge case: if OG is already at or below target FG
                fermentation_progress = (FG >= final_target_FG && og_sg >= final_target_FG) ? 100 : 0;
            }


            let statusText = "";
            let statusClass = "status ";
            let progressClass = "progress ";

            if (fermentation_progress >= 99 && FG <= (final_target_FG + 0.001)) {
                statusText = "Fermentation Complete (dry).";
                statusClass += "complete";
                progressClass += "complete";
            } else if (fermentation_progress >= 93) {
                statusText = "Fermentation nearly complete or complete (check FG).";
                statusClass += "complete";
                progressClass += "complete";
            } else {
                statusText = "Fermentation still active or in early stages.";
                statusClass += "active";
                progressClass += "active";
            }

            // Calculate Attenuation
            let attenuation = 0;
            if ((og_sg - 1) !== 0) { // Avoid division by zero
                attenuation = ((og_sg - FG) / (og_sg - 1)) * 100;
            }

            // Get unit display text
            const unitDisplayText = getUnitDisplayText(volumeUnit);
            const volumeDisplayValue = volumeUnit === 'ml' ? volumeMl.toFixed(0) : volumeInput.toFixed(volumeInput % 1 === 0 ? 0 : 2);


            document.getElementById("output").innerHTML = `
                <strong>Corrected OG (SG):</strong> ${og_sg.toFixed(4)}<br>
                <strong>Corrected FG (SG):</strong> ${FG.toFixed(4)}<br>
                <strong>ABV:</strong> ${abv_std.toFixed(2)}%<br>
                <strong>Apparent Attenuation:</strong> ${attenuation.toFixed(2)}%<br>
                <strong>Residual Sugar:</strong> ${residualSugarGL.toFixed(1)} g/L (${residualSugarInVolume.toFixed(1)}g in ${volumeDisplayValue}${unitDisplayText})<br>
                <strong>Sweetness Level:</strong> ${sweetnessPercentage.toFixed(0)}%<br>
                <div class="sweetness-bar-container">
                    <div class="sweetness-indicator" style="left: ${Math.min(100, Math.max(0, sweetnessPercentage))}%;"></div>
                </div>
                <div class="sweetness-labels">
                    <span>Bone Dry (0%)</span>
                    <span>Semi-Sweet (50%)</span>
                    <span>Dessert Sweet (100%)</span>
                </div>
                <strong>Estimated Calories per ${volumeDisplayValue}${unitDisplayText} for Alcohol & Sugar:</strong> ${alcoholAndSugarCalories.toFixed(0)} Kcal<br>
                <strong>Sweetness Classification:</strong> <span class="sweetness">${sweetness.simple}</span> (${sweetness.detailed})<br>
                <div class="${progressClass}">Fermentation Progress: ${fermentation_progress.toFixed(1)}%</div>
                <div class="${statusClass}">${statusText}</div>
            `;
            // Removed chart update for refractometer
            // updateChart('abvChartRefractometer', [og_sg, FG], abv_std.toFixed(2));
        }


        function calculateHydrometer() {
            const og_sg = parseFloat(document.getElementById("og_sg").value);
            const fg_sg = parseFloat(document.getElementById("fg_sg").value);
            const volumeInput = parseFloat(document.getElementById("volume_input_sg").value);
            const volumeUnit = document.getElementById("volume_unit_sg").value;
            const volumeMl = convertToMl(volumeInput, volumeUnit);

            if (isNaN(og_sg) || isNaN(fg_sg) || isNaN(volumeMl)) {
                document.getElementById("sg_output").innerHTML =
                    '<span class="active">Please enter valid numeric values for OG, FG, and Volume.</span>';
                abvChartHydrometer.destroy(); // Destroy chart if inputs are invalid
                return;
            }

            const abv = (og_sg - fg_sg) * 131.25;

            // Calculate residual sugar in g/L and for the specified volume
            const residualSugarGL = calculateResidualSugar(fg_sg);
            const residualSugarInVolume = (residualSugarGL * volumeMl) / 1000; // Convert to grams in the specified volume

            // Calculate calories for Alcohol & Sugar
            const alcoholAndSugarCalories = (volumeMl * (abv / 100) * 0.789) * 7 + (residualSugarInVolume * 4);

            // Calculate sweetness percentage for visual display (0-100%)
            const sweetnessPercentage = calculateSweetnessPercentage(residualSugarGL);

            // Calculate sweetness classification
            const sweetness = getSweetnessClassification(fg_sg, abv);

            const final_target_FG = 1.0001; // Target FG for 100% fermentation
            let fermentation_progress = 0;
            if ((og_sg - final_target_FG) !== 0) {
                fermentation_progress = ((og_sg - fg_sg) / (og_sg - final_target_FG)) * 100;
            } else if (og_sg <= fg_sg) { // Edge case: if OG is already at or below target FG
                fermentation_progress = (fg_sg >= final_target_FG && og_sg >= final_target_FG) ? 100 : 0;
            }

            let statusText = "";
            let statusClass = "status ";
            let progressClass = "progress ";

            if (fermentation_progress >= 99 && fg_sg <= (final_target_FG + 0.001)) {
                statusText = "Fermentation Complete (dry).";
                statusClass += "complete";
                progressClass += "complete";
            } else if (fermentation_progress >= 93) {
                statusText = "Fermentation nearly complete or complete (check FG).";
                statusClass += "complete";
                progressClass += "complete";
            } else {
                statusText = "Fermentation still active or in early stages.";
                statusClass += "active";
                progressClass += "active";
            }

            // Calculate Attenuation
            let attenuation = 0;
            if ((og_sg - 1) !== 0) { // Avoid division by zero
                attenuation = ((og_sg - fg_sg) / (og_sg - 1)) * 100;
            }

            // Get unit display text
            const unitDisplayText = getUnitDisplayText(volumeUnit);
            const volumeDisplayValue = volumeUnit === 'ml' ? volumeMl.toFixed(0) : volumeInput.toFixed(volumeInput % 1 === 0 ? 0 : 2);

            document.getElementById("sg_output").innerHTML = `
                <strong>ABV:</strong> ${abv.toFixed(2)}%<br>
                <strong>Apparent Attenuation:</strong> ${attenuation.toFixed(2)}%<br>
                <strong>Residual Sugar:</strong> ${residualSugarGL.toFixed(1)} g/L (${residualSugarInVolume.toFixed(1)}g in ${volumeDisplayValue}${unitDisplayText})<br>
                <strong>Sweetness Level:</strong> ${sweetnessPercentage.toFixed(0)}%<br>
                <div class="sweetness-bar-container">
                    <div class="sweetness-indicator" style="left: ${Math.min(100, Math.max(0, sweetnessPercentage))}%;"></div>
                </div>
                <div class="sweetness-labels">
                    <span>Bone Dry (0%)</span>
                    <span>Semi-Sweet (50%)</span>
                    <span>Dessert Sweet (100%)</span>
                </div>
                <strong>Estimated Calories per ${volumeDisplayValue}${unitDisplayText} for Alcohol & Sugar:</strong> ${alcoholAndSugarCalories.toFixed(0)} Kcal<br>
                <strong>Sweetness Classification:</strong> <span class="sweetness">${sweetness.simple}</span> (${sweetness.detailed})<br>
                <div class="${progressClass}">Fermentation Progress: ${fermentation_progress.toFixed(1)}%</div>
                <div class="${statusClass}">${statusText}</div>
            `;

            // Update chart data with current readings and any dynamically added readings
            const sgReadings = [
                { id: 'og_sg', label: 'Original', value: og_sg },
                { id: 'fg_sg', label: 'Final', value: fg_sg }
            ];

            // Add dynamic readings
            const dynamicReadingElements = document.querySelectorAll('#sg_readings_container .reading-row');
            dynamicReadingElements.forEach(row => {
                const dayInput = row.querySelector('input[type="text"]');
                const gravityInput = row.querySelector('input[type="number"]');
                if (dayInput && gravityInput) {
                    sgReadings.push({
                        id: gravityInput.id,
                        label: dayInput.value,
                        value: parseFloat(gravityInput.value)
                    });
                }
            });

            // Sort readings by SG value if needed for chart, or by time (day/order added)
            // For a "progress" chart, chronological order (as added) is more appropriate.
            // If the user manually inputs 'Day 5', 'Day 2', 'Day 7', they might want it in that order.
            // For now, let's keep the order as they are added, with OG and FG at start/end.
            const chartLabels = sgReadings.map(r => r.label);
            const chartData = sgReadings.map(r => r.value);

            updateChart('abvChartHydrometer', chartData, abv.toFixed(2), chartLabels);
        }

        function calculateSugarABV() {
            const sugarAmount = parseFloat(document.getElementById("sugar_amount").value);
            const sugarUnit = document.getElementById("sugar_unit").value;
            const volumeLiters = parseFloat(document.getElementById("volume_liters").value);
            const batchVolumeUnit = document.getElementById("batch_volume_unit").value;
            const conversionFactor = parseFloat(document.getElementById("conversion_factor").value);

            if (isNaN(sugarAmount) || isNaN(volumeLiters) || isNaN(conversionFactor)) {
                document.getElementById("sugar_abv_output").innerHTML =
                    '<span class="active">Please enter valid numeric values for all fields.</span>';
                return;
            }

            const totalSugarGrams = convertToGrams(sugarAmount, sugarUnit);
            const totalVolumeLiters = batchVolumeUnit === 'liter' ? volumeLiters : convertToMl(volumeLiters, batchVolumeUnit) / 1000;


            if (totalVolumeLiters <= 0 || conversionFactor <= 0) {
                document.getElementById("sugar_abv_output").innerHTML =
                    '<span class="active">Volume and Conversion Factor must be greater than zero.</span>';
                return;
            }

            const estimatedABV = (totalSugarGrams / totalVolumeLiters) / conversionFactor;

            document.getElementById("sugar_abv_output").innerHTML = `
                <strong>Estimated ABV:</strong> ${estimatedABV.toFixed(2)}%
            `;
        }

        function calculateRequiredSugar() {
            const targetAbv = parseFloat(document.getElementById("target_abv").value);
            const targetVolume = parseFloat(document.getElementById("target_volume").value);
            const targetVolumeUnit = document.getElementById("target_volume_unit").value;
            const targetFactor = parseFloat(document.getElementById("target_factor").value);

            if (isNaN(targetAbv) || isNaN(targetVolume) || isNaN(targetFactor)) {
                document.getElementById("required_sugar_output").innerHTML =
                    '<span class="active">Please enter valid numeric values for all fields.</span>';
                return;
            }

            const totalVolumeLiters = targetVolumeUnit === 'liter' ? targetVolume : convertToMl(targetVolume, targetVolumeUnit) / 1000;

            if (totalVolumeLiters <= 0 || targetFactor <= 0) {
                document.getElementById("required_sugar_output").innerHTML =
                    '<span class="active">Batch Volume and Sugar per 1% ABV must be greater than zero.</span>';
                return;
            }

            const requiredSugarGrams = (targetAbv * totalVolumeLiters * targetFactor);
            const requiredSugarKg = convertFromGrams(requiredSugarGrams, 'kg');
            const requiredSugarLbs = convertFromGrams(requiredSugarGrams, 'lbs');
            const requiredSugarOz = convertFromGrams(requiredSugarGrams, 'oz');

            document.getElementById("required_sugar_output").innerHTML = `
                <strong>Required Sugar:</strong> ${requiredSugarGrams.toFixed(1)} grams<br>
                (${requiredSugarKg.toFixed(2)} kg / ${requiredSugarLbs.toFixed(2)} lbs / ${requiredSugarOz.toFixed(1)} oz)
            `;
        }

        function calculatePrimingSugar() {
            const batchVolume = parseFloat(document.getElementById("prime_volume").value);
            const batchVolumeUnit = document.getElementById("prime_volume_unit").value;
            const co2Volumes = parseFloat(document.getElementById("co2_volumes").value);
            const currentTemp = parseFloat(document.getElementById("current_temp").value);
            const sugarType = document.getElementById("sugar_type").value;

            if (isNaN(batchVolume) || isNaN(co2Volumes) || isNaN(currentTemp)) {
                document.getElementById("priming_output").innerHTML =
                    '<span class="active">Please enter valid numeric values for all fields.</span>';
                return;
            }
            if (batchVolume <= 0) {
                document.getElementById("priming_output").innerHTML =
                    '<span class="active">Batch Volume must be greater than zero.</span>';
                return;
            }

            const batchVolumeLiters = batchVolumeUnit === 'liter' ? batchVolume : convertToMl(batchVolume, batchVolumeUnit) / 1000;

            // CO2 produced during fermentation (from online charts, typical for 20C)
            // This is a simplification; actual residual CO2 depends on exact fermentation profile and temperature history.
            const initialCo2 = getInitialCo2(currentTemp);

            // Target CO2 minus residual CO2
            const targetAdditionalCo2 = co2Volumes - initialCo2;

            if (targetAdditionalCo2 <= 0) {
                document.getElementById("priming_output").innerHTML =
                    '<span class="nearly">Warning: Desired CO2 is less than or equal to estimated residual CO2. No priming sugar might be needed, or CO2 will be very low.</span>';
                return;
            }

            let sugarFactor;
            switch (sugarType) {
                case 'table':
                    sugarFactor = 4; // grams of table sugar per liter for 1 volume CO2 (approx)
                    break;
                case 'corn':
                    sugarFactor = 4.2; // grams of corn sugar per liter for 1 volume CO2 (approx)
                    break;
                case 'dme':
                    sugarFactor = 6.6; // grams of DME per liter for 1 volume CO2 (approx)
                    break;
                case 'honey':
                    sugarFactor = 5.2; // grams of honey per liter for 1 volume CO2 (approx, varies greatly by type)
                    break;
                default:
                    sugarFactor = 4;
            }

            const requiredSugarGrams = targetAdditionalCo2 * batchVolumeLiters * sugarFactor;

            const requiredSugarOz = convertFromGrams(requiredSugarGrams, 'oz');

            document.getElementById("priming_output").innerHTML = `
                <strong>Required Priming Sugar (${sugarType}):</strong> ${requiredSugarGrams.toFixed(1)} grams<br>
                (${requiredSugarOz.toFixed(2)} oz)
            `;
        }

        function getInitialCo2(tempC) {
            // Very simplified estimation of dissolved CO2 at given temperature
            // This is a lookup table, more accurate would be a curve fit
            if (tempC <= 0) return 1.7;
            if (tempC <= 4) return 1.5;
            if (tempC <= 8) return 1.3;
            if (tempC <= 12) return 1.1;
            if (tempC <= 16) return 0.9;
            if (tempC <= 20) return 0.8;
            if (tempC <= 24) return 0.7;
            return 0.6; // Higher temperatures
        }

        function calculateDilution() {
            const currentAbv = parseFloat(document.getElementById("current_abv").value);
            const currentVolume = parseFloat(document.getElementById("current_volume").value);
            const currentVolumeUnit = document.getElementById("current_volume_unit").value;
            const targetAbv = parseFloat(document.getElementById("target_abv_dilution").value);
            const dilutionCalorieVolumeInput = parseFloat(document.getElementById("dilution_calorie_volume_input").value);
            const dilutionCalorieVolumeUnit = document.getElementById("dilution_calorie_volume_unit").value;
            const dilutionCalorieVolumeMl = convertToMl(dilutionCalorieVolumeInput, dilutionCalorieVolumeUnit);


            if (isNaN(currentAbv) || isNaN(currentVolume) || isNaN(targetAbv) || isNaN(dilutionCalorieVolumeMl)) {
                document.getElementById("dilution_output").innerHTML =
                    '<span class="active">Please enter valid numeric values for all fields.</span>';
                return;
            }

            if (currentAbv <= 0 || currentVolume <= 0 || targetAbv <= 0) {
                document.getElementById("dilution_output").innerHTML =
                    '<span class="active">ABV and Volume must be greater than zero.</span>';
                return;
            }
            if (targetAbv >= currentAbv) {
                document.getElementById("dilution_output").innerHTML =
                    '<span class="active">Target ABV must be less than Current ABV for dilution.</span>';
                return;
            }

            const currentVolumeLiters = currentVolumeUnit === 'liter' ? currentVolume : convertToMl(currentVolume, currentVolumeUnit) / 1000;


            // M1V1 = M2V2
            // currentAbv * currentVolume = targetAbv * totalNewVolume
            const totalNewVolumeLiters = (currentAbv * currentVolumeLiters) / targetAbv;
            const waterNeededLiters = totalNewVolumeLiters - currentVolumeLiters;

            const waterNeededMl = waterNeededLiters * 1000;
            const waterNeededUsFlOz = convertFromMl(waterNeededMl, 'us_fl_oz');
            const waterNeededUkFlOz = convertFromMl(waterNeededMl, 'uk_fl_oz');

            const totalVolumeMl = totalNewVolumeLiters * 1000;
            const totalVolumeUsFlOz = convertFromMl(totalVolumeMl, 'us_fl_oz');
            const totalVolumeUkFlOz = convertFromMl(totalVolumeMl, 'uk_fl_oz');

            // Calculate calories for Alcohol & Sugar (assuming only alcohol contributes, no sugar added)
            const alcoholCalories = (dilutionCalorieVolumeMl * (targetAbv / 100) * 0.789) * 7;

            const dilutionCalorieVolumeDisplayValue = dilutionCalorieVolumeUnit === 'ml' ? dilutionCalorieVolumeMl.toFixed(0) : dilutionCalorieVolumeInput.toFixed(dilutionCalorieVolumeInput % 1 === 0 ? 0 : 2);
            const dilutionCalorieUnitDisplayText = getUnitDisplayText(dilutionCalorieVolumeUnit);


            document.getElementById("dilution_output").innerHTML = `
                <strong>Water Needed:</strong> ${waterNeededLiters.toFixed(2)} Liters<br>
                (${waterNeededMl.toFixed(0)} mL / ${waterNeededUsFlOz.toFixed(2)} US fl oz / ${waterNeededUkFlOz.toFixed(2)} UK fl oz)<br>
                <strong>New Total Volume:</strong> ${totalNewVolumeLiters.toFixed(2)} Liters<br>
                (${totalVolumeMl.toFixed(0)} mL / ${totalVolumeUsFlOz.toFixed(2)} US fl oz / ${totalVolumeUkFlOz.toFixed(2)} UK fl oz)<br>
                <strong>Estimated Calories per ${dilutionCalorieVolumeDisplayValue}${dilutionCalorieUnitDisplayText}:</strong> ${alcoholCalories.toFixed(0)} Kcal (after dilution)
            `;
        }

        function calculateBlending() {
            const batch1Abv = parseFloat(document.getElementById("batch1_abv").value);
            const batch1Volume = parseFloat(document.getElementById("batch1_volume").value);
            const batch1VolumeUnit = document.getElementById("batch1_volume_unit").value;
            const batch2Abv = parseFloat(document.getElementById("batch2_abv").value);
            const batch2Volume = parseFloat(document.getElementById("batch2_volume").value);
            const batch2VolumeUnit = document.getElementById("batch2_volume_unit").value;

            if (isNaN(batch1Abv) || isNaN(batch1Volume) || isNaN(batch2Abv) || isNaN(batch2Volume)) {
                document.getElementById("blending_output").innerHTML =
                    '<span class="active">Please enter valid numeric values for all fields.</span>';
                return;
            }
            if (batch1Volume <= 0 || batch2Volume <= 0) {
                document.getElementById("blending_output").innerHTML =
                    '<span class="active">Batch volumes must be greater than zero.</span>';
                return;
            }

            const batch1VolumeMl = convertToMl(batch1Volume, batch1VolumeUnit);
            const batch2VolumeMl = convertToMl(batch2Volume, batch2VolumeUnit);


            // Total alcohol content
            const totalAlcohol = (batch1Abv / 100) * batch1VolumeMl + (batch2Abv / 100) * batch2VolumeMl;

            // Total volume
            const totalVolume = batch1VolumeMl + batch2VolumeMl;

            // Blended ABV
            const blendedAbv = (totalAlcohol / totalVolume) * 100;

            const totalVolumeLiters = totalVolume / 1000;
            const totalVolumeUsGal = convertFromMl(totalVolume, 'us_gallon');
            const totalVolumeUkGal = convertFromMl(totalVolume, 'uk_gallon');


            document.getElementById("blending_output").innerHTML = `
                <strong>Blended ABV:</strong> ${blendedAbv.toFixed(2)}%<br>
                <strong>Total Volume:</strong> ${totalVolumeLiters.toFixed(2)} Liters<br>
                (${totalVolume.toFixed(0)} mL / ${totalVolumeUsGal.toFixed(2)} US gal / ${totalVolumeUkGal.toFixed(2)} UK gal)
            `;
        }

        // --- Sweetness Calculation Functions (re-used from refractometer, applies to hydrometer too) ---

        function calculateResidualSugar(fg) {
            // A simplified estimation of residual sugar in g/L based on FG
            // This formula is a rough approximation. Actual residual sugar depends on
            // fermentability of wort, yeast strain, and other factors.
            // Water has an FG of 1.000, and 0 g/L sugar.
            // 1.010 SG is roughly 25 g/L sugar (approx 10 Brix)
            // This is a linear approximation, adjusted for more typical beer FGs.
            if (fg < 1.000) return 0; // Assuming no negative sugar
            return (fg - 1.000) * 250; // Roughly 250 g/L per 0.1 SG above 1.000
        }

        function calculateSweetnessPercentage(residualSugarGL) {
            // Max sweetness for scaling, adjust as needed (e.g., 100 g/L for dessert wine)
            const maxSugarFor100Percent = 100; // grams per liter
            return (residualSugarGL / maxSugarFor100Percent) * 100;
        }

        function getSweetnessClassification(fg, abv) {
            let simpleClassification = "Dry";
            let detailedClassification = "";

            if (fg <= 0.998) {
                simpleClassification = "Bone Dry";
                detailedClassification = "Most sugars fermented out, very crisp finish.";
            } else if (fg <= 1.002) {
                simpleClassification = "Dry";
                detailedClassification = "Residual sugars are minimal, classic dry profile.";
            } else if (fg <= 1.008) {
                simpleClassification = "Off-Dry";
                detailedClassification = "Slightly noticeable residual sweetness, balanced.";
            } else if (fg <= 1.015) {
                simpleClassification = "Semi-Sweet";
                detailedClassification = "Moderate sweetness, often balanced by acidity or high ABV.";
            } else {
                simpleClassification = "Sweet / Dessert";
                detailedClassification = "Significant residual sugar, rich and full-bodied.";
            }

            // Consider ABV for context, especially for 'dry' at high FG (e.g., strong ale)
            if (abv > 10 && fg > 1.005 && simpleClassification === "Dry") {
                detailedClassification += " Note: High ABV can mask sweetness, making it taste drier than FG suggests.";
            } else if (abv < 4 && fg < 1.000 && simpleClassification === "Bone Dry") {
                detailedClassification += " Light and crisp due to very low residual sugar.";
            }

            return { simple: simpleClassification, detailed: detailedClassification };
        }


        // --- Enable Auto-Updates ---
        function enableAutoUpdates(calculateFunction) {
            // Get all input and select elements in the current calculator section
            const calculatorSection = event.target.closest('.calculator-section');
            if (!calculatorSection) return;

            const inputs = calculatorSection.querySelectorAll('input[type="number"], input[type="text"], select');

            inputs.forEach(input => {
                // Remove any existing oninput or onchange to avoid duplicate listeners
                input.removeEventListener('input', calculateFunction);
                input.removeEventListener('change', calculateFunction);

                if (input.tagName === 'SELECT') {
                    input.addEventListener('change', calculateFunction);
                } else {
                    input.addEventListener('input', calculateFunction);
                }

                // Call the respective update function for unit display notes
                if (input.id.includes('volume_input') && input.id !== 'volume_input_sg') {
                    input.removeEventListener('input', updateVolumeDisplay);
                    input.addEventListener('input', updateVolumeDisplay);
                } else if (input.id.includes('volume_unit') && input.id !== 'volume_unit_sg') {
                    input.removeEventListener('change', updateVolumeDisplay);
                    input.addEventListener('change', updateVolumeDisplay);
                } else if (input.id.includes('volume_input_sg')) {
                    input.removeEventListener('input', updateVolumeDisplaySG);
                    input.addEventListener('input', updateVolumeDisplaySG);
                } else if (input.id.includes('volume_unit_sg')) {
                    input.removeEventListener('change', updateVolumeDisplaySG);
                    input.addEventListener('change', updateVolumeDisplaySG);
                } else if (input.id === 'sugar_amount' || input.id === 'sugar_unit') {
                    input.removeEventListener('input', updateSugarDisplay);
                    input.removeEventListener('change', updateSugarDisplay);
                    input.addEventListener('input', updateSugarDisplay);
                    input.addEventListener('change', updateSugarDisplay);
                } else if (input.id === 'volume_liters' || input.id === 'batch_volume_unit') {
                    input.removeEventListener('input', updateBatchVolumeDisplay);
                    input.removeEventListener('change', updateBatchVolumeDisplay);
                    input.addEventListener('input', updateBatchVolumeDisplay);
                    input.addEventListener('change', updateBatchVolumeDisplay);
                } else if (input.id === 'target_volume' || input.id === 'target_volume_unit') {
                    input.removeEventListener('input', updateTargetVolumeDisplay);
                    input.removeEventListener('change', updateTargetVolumeDisplay);
                    input.addEventListener('input', updateTargetVolumeDisplay);
                    input.addEventListener('change', updateTargetVolumeDisplay);
                } else if (input.id === 'prime_volume' || input.id === 'prime_volume_unit') {
                    input.removeEventListener('input', updatePrimeVolumeDisplay);
                    input.removeEventListener('change', updatePrimeVolumeDisplay);
                    input.addEventListener('input', updatePrimeVolumeDisplay);
                    input.addEventListener('change', updatePrimeVolumeDisplay);
                } else if (input.id === 'current_volume' || input.id === 'current_volume_unit') {
                    input.removeEventListener('input', updateDilutionCurrentVolumeDisplay);
                    input.removeEventListener('change', updateDilutionCurrentVolumeDisplay);
                    input.addEventListener('input', updateDilutionCurrentVolumeDisplay);
                    input.addEventListener('change', updateDilutionCurrentVolumeDisplay);
                } else if (input.id === 'batch1_volume' || input.id === 'batch1_volume_unit') {
                    input.removeEventListener('input', updateBatch1VolumeDisplay);
                    input.removeEventListener('change', updateBatch1VolumeDisplay);
                    input.addEventListener('input', updateBatch1VolumeDisplay);
                    input.addEventListener('change', updateBatch1VolumeDisplay);
                } else if (input.id === 'batch2_volume' || input.id === 'batch2_volume_unit') {
                    input.removeEventListener('input', updateBatch2VolumeDisplay);
                    input.removeEventListener('change', updateBatch2VolumeDisplay);
                    input.addEventListener('input', updateBatch2VolumeDisplay);
                    input.addEventListener('change', updateBatch2VolumeDisplay);
                } else if (input.id === 'dilution_calorie_volume_input' || input.id === 'dilution_calorie_volume_unit') {
                    input.removeEventListener('input', updateDilutionCalorieVolumeDisplay);
                    input.removeEventListener('change', updateDilutionCalorieVolumeDisplay);
                    input.addEventListener('input', updateDilutionCalorieVolumeDisplay);
                    input.addEventListener('change', updateDilutionCalorieVolumeDisplay);
                }
            });
            // Immediately calculate once
            calculateFunction();
        }

        // Wrappers to pass functions to enableAutoUpdates
        function calculateRefractometerAndEnableUpdates() {
            enableAutoUpdates(calculate);
        }

        function calculateHydrometerAndEnableUpdates() {
            enableAutoUpdates(calculateHydrometer);
        }

        function calculateSugarABVAndEnableUpdates() {
            enableAutoUpdates(calculateSugarABV);
        }

        function calculateRequiredSugarAndEnableUpdates() {
            enableAutoUpdates(calculateRequiredSugar);
        }

        function calculatePrimingSugarAndEnableUpdates() {
            enableAutoUpdates(calculatePrimingSugar);
        }

        function calculateDilutionAndEnableUpdates() {
            enableAutoUpdates(calculateDilution);
        }

        function calculateBlendingAndEnableUpdates() {
            enableAutoUpdates(calculateBlending);
        }


        let sgReadingCounter = 0; // To give unique IDs to new fields

        function addSgReadingField() {
            sgReadingCounter++;
            const container = document.getElementById('sg_readings_container');
            const readingDiv = document.createElement('div');
            readingDiv.className = 'volume-input-group reading-row'; // Add a new class for specific row styling
            readingDiv.dataset.readingId = sgReadingCounter; // Unique identifier for the row

            const labelDay = document.createElement('label');
            labelDay.htmlFor = `sg_day_${sgReadingCounter}`;
            labelDay.textContent = `Day/Time ${sgReadingCounter}:`;
            labelDay.style.display = 'none'; // Hide the label as we're putting it in a flex container

            const inputDay = document.createElement('input');
            inputDay.type = 'text';
            inputDay.id = `sg_day_${sgReadingCounter}`;
            inputDay.value = `Day ${sgReadingCounter}`; // Default value
            inputDay.placeholder = `Day/Time ${sgReadingCounter}`;
            inputDay.style.flex = '1'; // Take up available space
            inputDay.oninput = calculateHydrometer; // Update chart labels on input

            const labelGravity = document.createElement('label');
            labelGravity.htmlFor = `sg_value_${sgReadingCounter}`;
            labelGravity.textContent = `Current Gravity:`;
            labelGravity.style.display = 'none'; // Hide the label

            const inputGravity = document.createElement('input');
            inputGravity.type = 'number';
            inputGravity.step = '0.001';
            inputGravity.id = `sg_value_${sgReadingCounter}`;
            inputGravity.placeholder = 'SG Value';
            inputGravity.style.flex = '1'; // Take up available space
            inputGravity.oninput = calculateHydrometer; // Recalculate and update chart on input

            const removeButton = document.createElement('button');
            removeButton.textContent = 'X';
            removeButton.className = 'remove-reading-button';
            removeButton.onclick = function() {
                container.removeChild(readingDiv);
                calculateHydrometer(); // Recalculate chart after removing a field
            };

            readingDiv.appendChild(inputDay);
            readingDiv.appendChild(inputGravity);
            readingDiv.appendChild(removeButton);
            container.appendChild(readingDiv);

            // Re-calculate to update chart with new empty field or initial values
            calculateHydrometer();
        }

        function getUnitDisplayText(unit) {
            const unitMap = {
                ml: "mL",
                us_fl_oz: "US fl oz",
                uk_fl_oz: "UK fl oz",
                us_cup: "US cup",
                us_pint: "US pint",
                uk_pint: "UK pint",
                us_quart: "US quart",
                uk_quart: "UK quart",
                us_gallon: "US gal",
                uk_gallon: "UK gal",
                liter: "L",
                grams: "g",
                kg: "kg",
                lbs: "lbs",
                oz: "oz",
                us_cups: "US cups",
                uk_cups: "UK cups"
            };
            return unitMap[unit] || unit;
        }


        // Initial calculations and theme load on page load
        window.onload = function() {
            loadTheme();
            calculateRefractometerAndEnableUpdates();
            calculateHydrometerAndEnableUpdates();
            calculateSugarABVAndEnableUpdates();
            calculateRequiredSugarAndEnableUpdates();
            calculatePrimingSugarAndEnableUpdates();
            calculateDilutionAndEnableUpdates();
            calculateBlendingAndEnableUpdates();

            // Set default selected values for all volume/sugar units
            document.getElementById("volume_unit").value = "ml";
            document.getElementById("volume_unit_sg").value = "ml";
            document.getElementById("sugar_unit").value = "grams";
            document.getElementById("batch_volume_unit").value = "liter";
            document.getElementById("target_volume_unit").value = "liter";
            document.getElementById("prime_volume_unit").value = "ml"; /* Set to mL */
            document.getElementById("current_volume_unit").value = "liter";
            document.getElementById("batch1_volume_unit").value = "ml"; /* Set to mL */
            document.getElementById("batch2_volume_unit").value = "ml"; /* Set to mL */
            document.getElementById("dilution_calorie_volume_unit").value = "ml";


            // Trigger initial unit displays for all sections
            updateVolumeDisplay();
            updateVolumeDisplaySG();
            updateSugarDisplay();
            updateBatchVolumeDisplay();
            updateTargetVolumeDisplay();
            updatePrimeVolumeDisplay();
            updateDilutionCurrentVolumeDisplay();
            updateDilutionCalorieVolumeDisplay();
            updateBatch1VolumeDisplay();
            updateBatch2VolumeDisplay();

            // Clear initial results to ensure they are empty until first click
            document.getElementById("output").innerHTML = '';
            document.getElementById("sg_output").innerHTML = '';
            document.getElementById("sugar_abv_output").innerHTML = '';
            document.getElementById("required_sugar_output").innerHTML = '';
            document.getElementById("priming_output").innerHTML = '';
            document.getElementById("dilution_output").innerHTML = '';
            document.getElementById("blending_output").innerHTML = '';
        };
</script>
</body>
</html>
